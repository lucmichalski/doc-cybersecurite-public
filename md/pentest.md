# Scénario d'un pentest

## Le schéma le plus courant
Un parc de machine sous Windows, un annuaire AD et des serveurs sous Linux. Un certain nombre de services externes disponibles conséquences du nombre croissant d'outils collaboratifs et techno utilisées par les entreprises. Et bien sûr des utilisateurs ... 

Il est plutôt très facile de compromettre le réseau de l'intérieur, c'est par contre plus difficile d'y accéder de l'exterieur.

## Les défenses standards
De nombreuses techniques d'intrusion sont bien connues, et s'introduire sur un réseau d'entreprise, d'orgnanistion ou même d'un particulier nécessite de prendre en compte les techniques de défense standards
* anti-scanner réseau : le scanner est bruyant, typiquement les scanner Nmap sont très surveillés
* anti-scanner de vunlérébilité : les scanners de vulnérabilités, typiquement web, sont aussi très bruyant et sont assurément détectés
* anti-virus : les outils réputés type Metasploit/Meterpreter, sont évidemment identifiés et les outils produits par eux ont des signatures déjà connues des antivirus
* Surveillance des ouvertures de lignes de commandes
* Surveillance des accès AD pour authentification et nombre de tentatives d'authenification pour un utilisateur très limité

## Scenario
### Reconnaissance
Avec la reconnaissance passive et l'OSINT, il est possible de récolter un maximum d'information sur les utilisateurs ou les services de l'entreprise.

Il faut aussi préparer son système pour l'attaque en mettant notamment en place un serveur C2 sur un serveur virtuel privé en cloud (lightsail). 

### Trouver un point d'entrée
Pas d'utilisation des scanners type Nmap ou des scanners de vulnérabilités pour entrer ils sont trop bruyants.
Pour trouver un point d'entrée on peut:
* créer un domaine sosie et faire du spear phishing
* exploiter les services externes : mails(Office, Outlook WebApp ...), outils de communications (Lync...), de collaborations (Jira, Slack) ou autre (jenkins, CMS...)

Cette deuxième méthode à l'avantage d'attaquer des services reliés à l'AD, et ces services peuvent présenter qq faiblesses:
* pas de filtre sur les connexions externes
* un système orienté vers l'exterieur n'a pas forcément une authentification à 2 facteurs
* Réutilisation de mot de passe très elevée
* Ne vérouillent pas tj les comptes AD en cas de trop grand nb de tentatives de connexion

Pour réaliser le bruteforce, plutot que tenter sur un utilisateur, il faut tenter le password spraying avec l'outil `Spray` de Spiderlabs. Il permet de tester plusieurs services et plusieurs utilisateurs pour un même mot de passe.
Il est important d'exécuter très lentement pour ne pas déclencher le blocage du/des comptes. 
Le but est d'obtenir une identité parmis tout les utilisateurs pour mettre le pied d'en l'entreprise, pas tous ou pas un spécifique.

Quels mdp tester ? Certaines combinaisons permettent de réussir pour un moins un utilisateur:
* saison + année
* equipe sportive + chiffre
* nom de l'entreprise + année/chiffre/caractère spéciaux
* les breach & data leak sur le net 

Un autre outils pour le spaying est `Ruler` qui exploite Exchange. Ruler permettra ensuite, une fois que l'on a un pass, d'interroger Exchange pour avoir tout les users.

Autre moyen avec un accès physique, utiliser une penetration testing dropbox, ou une clé type USB Armory pour faire marcher `Responder` (et `Multirelay`) et récupérer les hash NTLM ou NTLMv2. Il faudra ensuite bruteforcer ce hash. Une fois sur un système du réseau il est possible d'utiliser l'attaque Inveigh avec Powershell.

Un dernier outils à ce stade, on a des credentials mais on ne sait pas ou les utiliser. `CrackMapExec` permet de tester les services du réseau avec les creds pour trouver sur quoi les connecter.

### Se situer et se déplacer dans le réseau
Une fois l'hôte initial compromis, il faut se situer sur le réseau, et comprendre comment il est organisé. Pour cela, l'outils `rtfm.py` facilite les commandes réseaux et système. 

Il est aussi utile pour se déplacer sur le réseau de mettre en place un serveur C2 et d'utiliser les outils permettant C2 (`Empire`, `dnscat2`...). Cela peut permettre un mouvement lateral pour accéder a un autre sous-réseau par exemple.

### Privileges escalation
Une première étape qui peut être intéressant est de récupérer les infos sur le système et ses mises à jour et chercher des vulnérabilités avec:
* `Windows Exploit Suggester`
* `Linux Exploit Suggester`

Le but n'est pas de limiter l'élévation de privilèges au compte système local mais au compte domain adimn afin de comprommettre tout le domaines. Il est possible que l'élévation de privilège locale est déjà permis de récupérer les creds domain admin si une connexion a eu lieu sur cette machine. Sinon il faut aller chercher un contôleur de domaine en étudiant le réseau, le compromettre et accéder au compte système via l'élévation de privilège locale.

### Une fois que l'on a le contrôle total
Exfiltration de données, persistance et rapport quand c'est un pentest